var demobo=demobo||{};
(function(f,q){"function"===typeof define&&define.amd?define(["underscore","backbone"],function(c,d){return q(c||f._,d||f.Backbone)}):q(_,Backbone)})(this,function(f,q){function c(a){Object.apply(this,arguments);f.defaults(a,c.DEFAULT_OPTIONS);this.options=a;this.targets={};this.add(a||{})}function d(a){Object.apply(this,arguments);this.guid=demobo.Utils.getDeviceID();this.type=a?a.type:"";this.channel=a?a.channel:"";this.firebaseUrl=demobo.discovery.options.firebaseUrl+"/communicationLayer"}function k(a){d.apply(this,
arguments);this.target=new Firebase(this.firebaseUrl+"/fb_"+this.channel);this.target.onDisconnect().remove();setTimeout(function(){this.onConnect&&this.onConnect.call(this);this.isSyncHost()||this.rpc("_remoteSync",[])}.bind(this),50)}function g(a){d.apply(this,arguments);var b=demobo.discovery.getHostIPAddress(),c=a.port;(function(){this.target=new DemoboWebsocket({channel:this.channel,id:this.guid,isHost:this.isHost(),internalIP:b,port:c});this.target.socketonopen=function(){this.onConnect&&this.onConnect.call(this);
this.isSyncHost()||this.rpc("_remoteSync",[])}.bind(this);this.target.socketonclose=function(){}.bind(this);this.target.socketonerror=function(){console.log("socket error");this.onFailure&&this.onFailure.call(this)}.bind(this)}).call(this);this.isHost()&&(demobo.discovery.deviceInfo.port=c)}function l(a){d.apply(this,arguments);this.target=new Alljoyn({channel:this.channel,id:this.guid,isHost:this.isHost()});setTimeout(function(){this.onConnect&&this.onConnect.call(this);this.isSyncHost()||this.rpc("_remoteSync",
[])}.bind(this),1500)}function m(a){d.apply(this,arguments);this.target=window.parent;setTimeout(function(){this.onConnect&&this.onConnect.call(this);this.isSyncHost()||this.rpc("_remoteSync",[])}.bind(this),0)}function n(a){d.apply(this,arguments);this.target=io.connect("127.0.0.1:4000");this.target.emit("create",this.channel);setTimeout(function(){this.onConnect&&this.onConnect.call(this);this.isSyncHost()||this.rpc("_remoteSync",[])}.bind(this),50)}function h(a){d.apply(this,arguments);this.target=
new WebrtcFirebase({firebaseUrl:this.firebaseUrl,channel:this.channel,guid:this.guid});this.target.onOpen=function(){this.onConnect&&this.onConnect.call(this);this.isSyncHost()||this.rpc("_remoteSync",[])}.bind(this)}var p={};c.prototype=Object.create(Object.prototype);c.prototype.constructor=c;c.DEFAULT_OPTIONS={timeout:3E3};c.prototype.add=function(a,b,d){d=d||function(){};b=b||function(){};if(!a.layers||!a.layers.length)this.remove(a),d.call(this);else{var c=a.layers[0].split(":"),c={type:c[0],
port:c[1],channel:a.channelID};if("websocket"==c.type&&demobo.discovery.isHost()){var f=this.getKey(a),e=this.targets[f];if(e&&"websocket"==e.type){delete e.state;e.ping.call(e);return}}switch(c.type){case "webrtc":c.channel=a.channelID+":"+a.connectionID;e=new h(c);break;case "firebase":e=new k(c);break;case "iframe":e=new m(c);break;case "socketio":e=new n(c);break;case "alljoyn":e=new l(c);break;case "websocket":e=new g(c)}if(e){this.remove(a);1==c.maxConnections&&(this.offMessage(),this.targets=
{});e.key=this.getKey(a);this.targets[e.key]=e;if(this.onMessageCallback)e.onMessage(this.onMessageCallback);e.onConnect=function(){e.ping.call(e)}.bind(this);e.onSuccess=function(){demobo.discovery.isHost()&&this.syncSet();b()}.bind(this);this.options.timeout&&setTimeout(function(){e.state||(delete demobo.discovery.deviceInfo.port,a.layers.shift(),this.add(a,b,d))}.bind(this),this.options.timeout)}else console.log("Communication Layer set up fails")}};c.prototype.getKey=function(a){return a.host+
a.guest||a.channelID+a.connectionID};c.prototype.remove=function(a){a=this.getKey(a);var b=this.targets[a];b&&(b.offMessage(),delete this.targets[a])};c.prototype.set=function(a,b){a&&(p[a]=b);f(this.targets).map(function(c){c.set(a,b)})};c.prototype.get=function(a){return p[a]};c.prototype.syncSet=function(){f(p).map(function(a,b){this.set(b,a)}.bind(this))};c.prototype.rpc=function(a,b){f(this.targets).map(function(c){c.rpc(a,b)})};c.prototype.postMessage=function(a){f(this.targets).map(function(b){b.postMessage(a)})};
c.prototype.onMessage=function(a){this.onMessageCallback=a;f(this.targets).map(function(b){b.onMessage(a)})};c.prototype.offMessage=function(){f(this.targets).map(function(a){a.offMessage()})};d.prototype=Object.create(Object.prototype);d.prototype.constructor=d;d.DEFAULT_OPTIONS={};d.prototype.isHost=function(){return demobo.discovery.isHost()};d.prototype.isSyncHost=function(){return demobo.discovery.isSyncHost()};d.prototype.ping=function(){setTimeout(function(){this.postMessage({method:"ping",
key:this.key,from:this.guid})}.bind(this),500)};d.prototype.pings=function(a){a--;this.ping();0<a&&setTimeout(function(){this.pings.call(this,a)}.bind(this),100)};d.prototype.set=function(a,b){this.postMessage({method:"set",key:a,value:b,from:this.guid})};d.prototype.rpc=function(a,b){var c=JSON.stringify([a,b]);this.postMessage({message:c,from:this.guid})};d.prototype.postMessage=function(a){};d.prototype.onMessage=function(a){};d.prototype.offMessage=function(){};d.prototype.handleMessageCallback=
function(a,b){a&&this.guid!=a.from&&("ping"==a.method?a.key==this.key&&a.from!=this.guid&&!this.state&&(this.state=1,this.ping.call(this),this.onSuccess()):"set"==a.method?a.key&&(p[a.key]=a.value):a.message&&b(a.message))};k.prototype=Object.create(d.prototype);k.prototype.constructor=k;k.DEFAULT_OPTIONS={};k.prototype.postMessage=function(a){this.target.set(a)};k.prototype.onMessage=function(a){this.messageCallback=function(b){(b=b.val())&&this.handleMessageCallback(b,a)}.bind(this);this.target.on("value",
this.messageCallback)};k.prototype.offMessage=function(){this.target.off("value",this.messageCallback)};g.prototype=Object.create(d.prototype);g.prototype.constructor=g;g.DEFAULT_OPTIONS={};g.prototype.postMessage=function(a){this.target.send(a)};g.prototype.onMessage=function(a){this.messageCallback=function(b){this.handleMessageCallback(b,a)}.bind(this);this.target.onMessage(this.messageCallback)};g.prototype.offMessage=function(){this.target.offMessage()};g.prototype.set=function(a,b){};l.prototype=
Object.create(d.prototype);l.prototype.constructor=l;l.DEFAULT_OPTIONS={};l.prototype.postMessage=function(a){this.target.send("message",a)};l.prototype.onMessage=function(a){this.messageCallback=function(b){this.handleMessageCallback(b,a)}.bind(this);this.target.on("message",this.messageCallback)};l.prototype.offMessage=function(){this.target.off("message",this.messageCallback)};m.prototype=Object.create(d.prototype);m.prototype.constructor=m;m.DEFAULT_OPTIONS={};m.prototype.postMessage=function(a){this.target.postMessage(a,
"*")};m.prototype.onMessage=function(a){this.messageCallback=function(b){this.handleMessageCallback(b.data,a)}.bind(this);window.addEventListener?window.addEventListener("message",this.messageCallback,!1):window.attachEvent("onmessage",this.messageCallback)};m.prototype.offMessage=function(){window.removeEventListener?window.removeEventListener("message",this.messageCallback,!1):window.detachEvent("onmessage",this.messageCallback)};n.prototype=Object.create(d.prototype);n.prototype.constructor=n;
n.DEFAULT_OPTIONS={};n.prototype.postMessage=function(a){this.target.emit("message",a)};n.prototype.onMessage=function(a){this.messageCallback=function(b){this.handleMessageCallback(b,a)}.bind(this);this.target.on("message",this.messageCallback)};n.prototype.offMessage=function(){this.target.off("message",this.messageCallback)};h.prototype=Object.create(d.prototype);h.prototype.constructor=h;h.DEFAULT_OPTIONS={};h.prototype.postMessage=function(a){this.target.sendMessage&&this.target.sendMessage(a)};
h.prototype.onMessage=function(a){this.messageCallback=function(b){this.handleMessageCallback(b,a)}.bind(this);this.target.messageCallback=this.messageCallback};h.prototype.offMessage=function(){delete this.target.messageCallback};h.prototype.set=function(a,b){};demobo.CommunicationLayer=c;demobo.communicationLayer=new demobo.CommunicationLayer({});return demobo.CommunicationLayer});
(function(e,d){"function"===typeof define&&define.amd?define(["underscore","backbone"],function(f,g){return d(f||e._,g||e.Backbone)}):d(_,Backbone)})(this,function(e,d){function f(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function g(a){return a&&JSON.parse(a)}var l=demobo.communicationLayer,m=l.rpc.bind(l),h={};(function(){function a(a,c){var d=new CustomEvent("storage");d.key=a;d.newValue=c;window.dispatchEvent(d)}function c(a){e(h).map(function(c){c.onStorage.call(c,a)})}l.onMessage.call(l,
function(b){b=g(b);var c=b[0],d=b[1][0];"_remoteSync"==c?d?(b=h[d])&&b.localStorage._remoteSync.call(b.localStorage):e(h).map(function(a){a.localStorage._remoteSync.call(a.localStorage)}):"_remoteSyncStart"==c?(b=h[d])&&b.localStorage._clear.call(b.localStorage):"_setItem"==c?(b=e.toArray(b[1]),1<e(l.targets).size()&&localStorage.__proto__.setItem.apply(localStorage,b)||localStorage.__proto__._setItem.apply(localStorage,b),a.apply(window,b)):"_removeItem"==c?(b=e.toArray(b[1]),1<e(l.targets).size()&&
localStorage.__proto__.removeItem.apply(localStorage,b)||localStorage.__proto__._removeItem.apply(localStorage,b),a.apply(window,b)):"_remoteSyncEnd"==c?(b=h[d])&&b.fetch.call(b):"_debug"==c&&console.log("_debug",b)});window.addEventListener?window.addEventListener("storage",c,!1):window.attachEvent("onstorage",c)})();d.DemoboStorage=function(a){this.name="DemoboStorage-"+a.name;this.restore()};e.extend(d.DemoboStorage.prototype,{restore:function(){var a=this.localStorage().getItem(this.name);this.records=
a&&a.split(",")||[]},save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(a){a.id||(a.id=f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f(),a.set(a.idAttribute,a.id));this.localStorage().setItem(this.name+"-"+a.id,JSON.stringify(a));this.records.push(a.id.toString());this.save();return this.find(a)},update:function(a){this.localStorage().setItem(this.name+"-"+a.id,JSON.stringify(a));e.include(this.records,a.id.toString())||this.records.push(a.id.toString());
this.save();return this.find(a)},find:function(a){return g(this.localStorage().getItem(this.name+"-"+a.id))},findAll:function(){return e(this.records).chain().map(function(a){return g(this.localStorage().getItem(this.name+"-"+a))},this).compact().value()},destroy:function(a){if(a.isNew())return!1;this.localStorage().removeItem(this.name+"-"+a.id);this.records=e.reject(this.records,function(c){return c===a.id.toString()});this.save();return a},localStorage:function(){return localStorage},_clear:function(){var a=
this.localStorage(),c=RegExp("^"+this.name+"-");a._removeItem(this.name);e.chain(a).keys().filter(function(a){return c.test(a)}).each(function(b){a._removeItem(b)})},_storageSize:function(){return this.localStorage().length},_remoteSync:function(){m("_remoteSyncStart",[this.name]);setTimeout(function(){var a=this.localStorage(),c=RegExp("^"+this.name+"-");m("_setItem",[this.name,a.getItem(this.name)]);e.chain(a).keys().filter(function(a){return c.test(a)}).each(function(b){m("_setItem",[b,a.getItem(b)])});
m("_remoteSyncEnd",[this.name])}.bind(this),1E3)}});d.DemoboStorage.sync=d.localSync=function(a,c,b){var e=c.localStorage||c.collection.localStorage,f,k,g=$.Deferred&&$.Deferred();try{switch(a){case "read":f=void 0!=c.id?e.find(c):e.findAll();break;case "create":f=e.create(c);break;case "update":f=e.update(c);break;case "delete":f=e.destroy(c)}}catch(h){k=h.code===DOMException.QUOTA_EXCEEDED_ERR&&0===e._storageSize()?"Private browsing is unsupported":h.message}f?(c.trigger("sync",c,f,b),b&&b.success&&
("0.9.10"===d.VERSION?b.success(c,f,b):b.success(f)),g&&g.resolve(f)):(k=k?k:"Record Not Found",c.trigger("error",c,k,b),b&&b.error&&("0.9.10"===d.VERSION?b.error(c,k,b):b.error(k)),g&&g.reject(k));b&&b.complete&&b.complete(f);return g&&g.promise()};d.ajaxSync=d.sync;d.getSyncMethod=function(a){return a.localStorage||a.collection&&a.collection.localStorage?d.localSync:d.ajaxSync};d.sync=function(a,c,b){return d.getSyncMethod(c).apply(this,[a,c,b])};localStorage.__proto__._setItem=localStorage.__proto__.setItem;
localStorage.__proto__.setItem=function(){var a=arguments[0],c=arguments[1];if(localStorage.getItem(a)==c)return!1;0==a.indexOf("DemoboStorage-")&&m("_setItem",arguments);localStorage.__proto__._setItem.apply(this,arguments);return!0};localStorage.__proto__._removeItem=localStorage.__proto__.removeItem;localStorage.__proto__.removeItem=function(){var a=arguments[0],c=arguments[1];if(localStorage.getItem(a)==c)return!1;0==a.indexOf("DemoboStorage-")&&m("_removeItem",arguments);localStorage.__proto__._removeItem.apply(this,
arguments);return!0};d.DemoboStorage.Collection=d.Collection.extend({initialize:function(){this.localStorage=new d.DemoboStorage({name:this.demoboID});h[this.localStorage.name]=this},handleStorageEvent:function(a,c){if(a===this.localStorage.name)this.localStorage.restore();else{var b=a.split(this.localStorage.name+"-")[1];b&&(c?(b=g(c),this.add.call(this,[b],{silent:!1,merge:!0})):(b=this.get(b))&&b.trigger("destroy",b,this))}},onStorage:function(a){var c=a.key;a=this.localStorage.localStorage().getItem(a.key);
this.handleStorageEvent.call(this,c,a)}});d.DemoboStorage.Model=d.Model.extend({initialize:function(){this.localStorage=new d.DemoboStorage({name:this.demoboID});h[this.localStorage.name]=this},handleStorageEvent:function(a,c){if(a===this.localStorage.name)this.localStorage.restore();else if(a.split(this.localStorage.name+"-")[1]==this.id)if(c){var b=g(c);this.save(b)}else this&&this.trigger("destroy",this,this)},onStorage:function(a){var c=a.key;a=this.localStorage.localStorage().getItem(a.key);
this.handleStorageEvent.call(this,c,a)}});return d.DemoboStorage});
var demobo=demobo||{};
(function(){var a={S4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){return a.S4()+a.S4()+"-"+a.S4()+"-"+a.S4()+"-"+a.S4()+"-"+a.S4()+a.S4()+a.S4()},getDeviceID:_.memoize(function(){return"undefined"!=typeof demobo_guid?demobo_guid:a.guid()}),isChrome:_.memoize(function(){return navigator.userAgent.match(/(Chrome)/)}),isMobile:_.memoize(function(){return navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)}),isAndroid:_.memoize(function(){return navigator.userAgent.match(/(Android)/)}),isIOS:_.memoize(function(){return navigator.userAgent.match(/(iPhone|iPod|iPad)/)})};
demobo.Utils=a})();
var demobo=demobo||{};
(function(){function b(a){Object.apply(this,arguments);_.defaults(a,b.DEFAULT_OPTIONS);this.options=a;void 0==this.options.isSyncHost&&(this.options.isSyncHost=this.options.isHost);h.call(this);this.initDeviceInfo.call(this);k.call(this)}function h(){this.pairingTimeout;this.onPairing=this.options.onPairing;this.onSuccess=function(){this.pairingTimeout&&clearTimeout(this.pairingTimeout);this.options.onSuccess()}.bind(this);this.onFailure=function(){this.pairingTimeout&&clearTimeout(this.pairingTimeout);this.options.onFailure()}.bind(this);
this.onTimeout=function(){this.pairingTimeout&&clearTimeout(this.pairingTimeout);this.options.onTimeout()}.bind(this);this.rootUrl=this.options.firebaseUrl+"/"+this.options.appName+"/";this.pairingUrl=this.options.firebaseUrl+"/"+this.options.appName+"/pairing/";this.enabled=!1;this.pairing={};this.pairing.candidates=[];this.pairing.pairedMembers=[];this.failCallback=this.successCallback=null;this.allowMesh=this.options.allowMesh}function k(){this.keydownHandler=function(a){32==a.keyCode&&setTimeout(this.onPairingTrigger.bind(this),
2*l.delay)}.bind(this);this.onPairHandler=function(a){a=a.val();_.each(a,function(a){this.pairing.candidates.push(a)}.bind(this))}.bind(this)}function e(a){this.removeTimeout&&clearTimeout(this.removeTimeout);this.removeTimeout=setTimeout(function(){this.pairingRef.off("child_added");this.pairingRef.off("value");this.pairingRef.child(this.getDeviceInfo().deviceID).remove()}.bind(this),a)}function f(){var a=_.find(this.pairing.candidates,function(a){return a.deviceID==this.getDeviceInfo().deviceID}.bind(this));
a&&(this.pairing.pairedMembers=this.pairing.candidates.filter(function(c){return c.deviceID==this.getDeviceInfo().deviceID?!1:"code"==this.options.method?c.code&&a.code==c.code:Math.abs(c.serverTime-a.serverTime)<=this.options.paringTolerance}.bind(this)),m.call(this,a));this.pairing.candidates=[]}function m(a){this.roomRef=null;if(1==this.pairing.pairedMembers.length){var c=this.pairing.pairedMembers[0];if(!c.channelID||!a.channelID)if((c.channelID||a.channelID)&&!c.isHost&&!a.isHost)this.allowMesh?
n.call(this,a):this.failCallback(c.host?c.host:a.host);else{c=this.pairing.pairedMembers[0];if(!(a.isHost&&!c.isHost||!a.isHost&&c.isHost)){var b=this.isMobile(),d=this.isAgentMobile(c.userAgent);d&&b||!d&&!b?this.getDeviceInfo().isHost=a.serverTime<=c.serverTime:d&&!b?this.getDeviceInfo().isHost=!0:!d&&b&&(this.getDeviceInfo().isHost=!1)}p.call(this,a)}}else this.roomRef&&this.failCallback("more then one device is pairing")}function n(a){var c="",c=a.channelID?this.pairing.pairedMembers[0].deviceID:
a.deviceID;this.getDeviceInfo().roomId=c;this.roomRef=new Firebase(this.rootUrl+"connected/"+c);this.roomRef.onDisconnect().remove();a.channelID?(a={},a.connectionID=demobo.Utils.guid(),a.host=this.getDeviceInfo().host,a.layers=this.getDeviceInfo().layers,a.channelID=this.getDeviceInfo().channelID,a.hostInfo=this.getDeviceInfo().hostInfo,a=_.compactObject(a),this.roomRef.update(a,function(){this.roomOnValue=function(a){if((a=a.val())&&a.guest)this.roomRef.off("value",this.roomOnValue),this.successCallback(a)}.bind(this);
this.roomRef.on("value",this.roomOnValue)}.bind(this))):g.call(this)}function p(a){var c="",c=this.getDeviceInfo().isHost?this.pairing.pairedMembers[0].deviceID:a.deviceID;this.getDeviceInfo().roomId=c;this.roomRef=new Firebase(this.rootUrl+"connected/"+c);this.roomRef.onDisconnect().remove();this.getDeviceInfo().isHost?(a={},this.getDeviceInfo().channelID||(this.getDeviceInfo().channelID=demobo.Utils.guid()),a.channelID=this.getDeviceInfo().channelID,a.connectionID=demobo.Utils.guid(),a.host=this.getDeviceInfo().deviceID,
a.hostInfo={},a.hostInfo.internalIP=this.getDeviceInfo().internalIP||"",a.hostInfo.userAgent=this.getDeviceInfo().userAgent||"",this.getDeviceInfo().hostInfo=a.hostInfo,a.layers=this.getDeviceInfo().layers,a=_.compactObject(a),this.roomRef.update(a,function(){this.roomOnValue=function(a){if((a=a.val())&&a.guest)this.roomRef.off("value",this.roomOnValue),this.successCallback(a)}.bind(this);this.roomRef.on("value",this.roomOnValue)}.bind(this))):g.call(this)}function g(){this.roomOnValue=function(a){if(a=
a.val())a.layers=_.intersection(a.layers,this.getDeviceInfo().layers),a.guest=this.getDeviceInfo().deviceID,this.roomRef.off("value",this.roomOnValue),this.getDeviceInfo().host=a.host,this.getDeviceInfo().channelID=a.channelID,this.getDeviceInfo().hostInfo=a.hostInfo,a=_.compactObject(a),this.roomRef.update(a),this.successCallback(a)}.bind(this);this.roomRef.on("value",this.roomOnValue)}function q(){this.pairingRef.off("child_added");this.pairingRef.off("value");if("code"==this.options.method&&this.isHost())this.pairingRef.on("child_added",
function(){setTimeout(function(){this.pairingRef.once("value",function(a){this.onPairHandler(a);f.call(this)}.bind(this))}.bind(this),this.options.paringTolerance)}.bind(this));else this.pairingRef.once("child_added",function(){setTimeout(function(){this.pairingRef.once("value",function(a){this.onPairHandler(a);f.call(this)}.bind(this))}.bind(this),this.options.paringTolerance)}.bind(this))}function r(a){return!a?[]:a.split(".").map(function(a){return Number(a)})}function s(a){return a.split("").reverse().reduce(function(a,
b,d){return"abcdefghijklmnopqrstuvwxyz".indexOf(b)*Math.pow(26,d)+a},0)-12345678}var l=demobo.SimpleBump;b.prototype=Object.create(Object.prototype);b.prototype.constructor=b;b.DEFAULT_OPTIONS={firebaseUrl:"https://demobo.firebaseio.com",appName:"discovery",paringTolerance:1E3,dataKeptTime:5E3,mode:"conference",isHost:!1,method:"bump",timeout:6E3};b.prototype.initDeviceInfo=function(){this.deviceInfo={deviceID:demobo.Utils.getDeviceID(),platform:navigator.platform,userAgent:navigator.userAgent,layers:this.options.layers||
this.getAvailableLayers(),isHost:this.options.isHost,roomId:null,channelID:null,host:null,externalID:demobo_r};this.isMobile()&&window.getIPAddress&&window.getIPAddress(!0,function(a){_.extend(this.deviceInfo,{internalIP:a})}.bind(this),function(a){console.log(a)});this.options.alwaysOn&&this.deviceInfo.externalID&&setTimeout(function(){this.enable()}.bind(this),0)};b.prototype.enable=function(){this.enabled||(this.enabled=!0,"code"==this.options.method?this.startCodePairing():this.startBumpPairing())};
b.prototype.disable=function(){this.enabled&&(this.enabled=!1,"code"==this.options.method?this.endCodePairing():this.endBumpPairing())};b.prototype.search=function(a,c){"function"===typeof a&&(this.successCallback=_.debounce(a,300,!0));"function"===typeof c&&(this.failCallback=_.debounce(c,300,!0))};b.prototype.getDeviceInfo=function(){return this.deviceInfo};b.prototype.getDeviceID=function(){return this.deviceInfo.deviceID};b.prototype.isMobile=function(){return navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)};
b.prototype.isAgentMobile=function(a){return a.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/)};b.prototype.getAvailableLayers=function(){var a=["firebase"];a.unshift("websocket:8010");a.unshift("websocket:80");"undefined"!=typeof webrtcDetectedBrowser&&webrtcDetectedBrowser&&a.unshift("webrtc");this.isMobile()&&"undefined"!=typeof Alljoyn&&a.unshift("alljoyn");return a};b.prototype.isSyncHost=function(){return this.options.isSyncHost};b.prototype.isHost=function(){return this.getDeviceInfo().isHost};
b.prototype.getIPAddress=function(){return this.getDeviceInfo().internalIP};b.prototype.getCodeFromIP=function(a){a=r(a);var c=0;192==a[0]?c=256*a[2]+a[3]:172==a[0]?c=65536+65536*(a[1]-16)+256*a[2]+a[3]:10==a[0]&&(c=1114112+65536*a[1]+256*a[2]+a[3]);a=c+12345678;return["abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(a/11881376)%26),"abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(a/456976)%26),"abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(a/17576)%26),"abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(a/
676)%26),"abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(a/26)%26),"abcdefghijklmnopqrstuvwxyz".charAt(a%26)].join("")};b.prototype.getIPFromCode=function(a){a=s(a);var c=[0,0,0,0];65536>a?c=[192,168,Math.floor(a/256),a%256]:1114112>a?(a-=65536,c=[172,16+Math.floor(a/65536),Math.floor(a/256)%256,a%256]):17891328>a&&(a=a-65536-1048576,c=[10,Math.floor(a/65536),Math.floor(a/256)%256,a%256]);return c.join(".")};b.prototype.getHostIPAddress=function(){return this.getDeviceInfo().hostInfo.internalIP};b.prototype.isServer=
function(){return this.getDeviceInfo().hostInfo.internalIP===this.getDeviceInfo().internalIP};b.prototype.getRoomID=function(){return this.deviceInfo.externalID.replace(/\./g,"dot")};b.prototype.onPairingTrigger=function(){q.call(this);var a=this.pairingRef;if(a){var c=_.compactObject(this.getDeviceInfo());c.serverTime=Firebase.ServerValue.TIMESTAMP;var b={};b[c.deviceID]=c;b=_.compactObject(b);a.update(b)}this.getDeviceInfo().isHost||e.call(this,this.options.dataKeptTime);this.onPairing&&(this.onPairing(),
this.pairingTimeout=setTimeout(this.onTimeout,this.options.timeout))};b.prototype.startBumpPairing=function(){if(this.deviceInfo.externalID&&"undefined"!=typeof Firebase){var a=this.pairingUrl+this.getRoomID();this.pairingRef=new Firebase(a);this.isMobile()?(this.onPairingTriggerRef=this.onPairingTrigger.bind(this),document.addEventListener("volumedownbutton",this.onPairingTriggerRef,!1),document.addEventListener("volumeupbutton",this.onPairingTriggerRef,!1)):window.addEventListener("keydown",this.keydownHandler)}};
b.prototype.endBumpPairing=function(){e.call(this,0);this.isMobile()?(document.removeEventListener("volumedownbutton",this.onPairingTriggerRef,!1),document.removeEventListener("volumeupbutton",this.onPairingTriggerRef,!1)):window.removeEventListener("keydown",this.keydownHandler)};b.prototype.startCodePairing=function(){if(this.deviceInfo.externalID){var a=this.pairingUrl+this.getRoomID();this.pairingRef=new Firebase(a);if(this.isMobile()){var b=this.options.code||Math.random().toString(36).substr(2,
4);this.pairingRef.on("value",function(a){a.forEach(function(a){a.val().code==b&&a.ref.remove()});this.enterCode(b)}.bind(this))}}};b.prototype.endCodePairing=function(){e.call(this,0)};b.prototype.enterCode=function(a){this.deviceInfo.code=a;this.onPairingTrigger()};b.prototype.connectWIFI=function(a){"undefined"!=typeof configs&&!configs.dev&&(a={channelID:"1ae5d720-6a9f-bb3a-24b4-086811a42d7c",connectionID:"a4e79935-ee0f-8766-da06-6c06d510492e",host:"mobile",hostInfo:{internalIP:a},layers:this.options.layers,
guest:"web",roomId:"web"},demobo.communicationLayer.remove(a),this.getDeviceInfo().roomId=a.roomId,this.getDeviceInfo().host=a.host,this.getDeviceInfo().channelID=a.channelID,this.getDeviceInfo().hostInfo=a.hostInfo,demobo.communicationLayer.options.timeout=null,demobo.communicationLayer.add(a,this.onSuccess,this.onFailure),console.log("connectWIFI"))};b.prototype.connectWIFIByCode=function(a){this.connectWIFI(this.getIPFromCode(a))};demobo.Discovery=b})();
var demobo=demobo||{};(function(){demobo.init=function(a){Object.apply(this,arguments);demobo.discovery=new demobo.Discovery(a);demobo.discovery.search(function(a){console.log(a);a.channelID&&a.connectionID&&a.layers.length?demobo.communicationLayer.add(a,demobo.discovery.onSuccess,demobo.discovery.onFailure):(demobo.discovery.onFailure(),console.log("Connection failed: no channel/layer available."))}.bind(this),function(a){demobo.discovery.onFailure();console.log("Connection failed: error ",a)})}})();
if("undefined"==typeof DemoboWebsocket){var DemoboWebsocket=function(a){this.channel=a.channel;this.id=a.id;this.isHost=a.isHost;this.port=a.port;this.internalIP=a.internalIP;setTimeout(this.init.bind(this),1E3)};DemoboWebsocket.prototype=Object.create(Object.prototype);DemoboWebsocket.prototype.constructor=DemoboWebsocket}
DemoboWebsocket.prototype.init=function(){this.socket=new WebSocket("ws://"+this.internalIP+":"+this.port);this.socket.onmessage=this.socketonmessage;this.socket.onopen=this.socketonopen;this.socket.onclose=this.socketonclose;this.socket.onerror=this.socketonerror};DemoboWebsocket.prototype.send=function(a){this.socket&&this.socket.send(JSON.stringify(a))};DemoboWebsocket.prototype.onMessage=function(a){this.socketonmessage=function(b){a(JSON.parse(b.data))}};
DemoboWebsocket.prototype.offMessage=function(){this.socket&&delete this.socket.onmessage};_.mixin({compactObject:function(a){var b=_.clone(a);_.each(b,function(a,c){a||delete b[c]});return b}});
